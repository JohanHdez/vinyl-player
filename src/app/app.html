<div class="app-shell" [class.sidebar-collapsed]="sidebarCollapsed()" [class.has-player]="hasSong()">

  <!-- ═══ SIDEBAR ═══ -->
  <aside class="sidebar">
    <div class="sidebar-inner">
      <!-- Brand -->
      <div class="sidebar-brand" (click)="setView('home')">
        <div class="brand-icon">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="12" r="3" fill="currentColor"/><circle cx="12" cy="12" r="6" fill="none" stroke="currentColor" stroke-width="0.5" opacity="0.4"/><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="0.3" opacity="0.2"/></svg>
        </div>
        <span class="brand-text">VINYL</span>
      </div>

      <!-- Navigation -->
      <nav class="sidebar-nav">
        <button class="nav-item" [class.active]="currentView() === 'home'" (click)="setView('home')">
          <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
          <span class="nav-label">Inicio</span>
        </button>
        <button class="nav-item" [class.active]="currentView() === 'search'" (click)="setView('search')">
          <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          <span class="nav-label">Buscar</span>
        </button>
        <button class="nav-item" [class.active]="currentView() === 'library'" (click)="setView('library')">
          <svg viewBox="0 0 24 24"><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
          <span class="nav-label">Biblioteca</span>
        </button>

        @if (hasSong()) {
          <div class="nav-divider"></div>
          <button class="nav-item nav-item--accent" [class.active]="currentView() === 'nowplaying'" (click)="setView('nowplaying')">
            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            <span class="nav-label">Tocando</span>
          </button>
        }
      </nav>

      <!-- Sidebar collapse toggle -->
      <button class="sidebar-toggle" (click)="toggleSidebar()">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>

      <!-- Mini now playing in sidebar -->
      @if (hasSong()) {
        <div class="sidebar-now-playing" (click)="setView('nowplaying')">
          <img [src]="currentThumb()" alt="" class="sidebar-thumb">
          <div class="sidebar-song-info">
            <div class="sidebar-song-title">{{ currentSong()?.title }}</div>
            <div class="sidebar-song-artist">{{ currentSong()?.channel }}</div>
          </div>
          <div class="sidebar-eq" [class.playing]="isPlaying()">
            <span></span><span></span><span></span>
          </div>
        </div>
      }
    </div>
  </aside>

  <!-- ═══ MAIN CONTENT ═══ -->
  <main class="main-content">

    <!-- HOME VIEW -->
    @if (currentView() === 'home') {
      <div class="view-pane view-home">
        <div class="view-header">
          <h1 class="view-title font-display">Descubre</h1>
          <p class="view-subtitle">Musica en tendencia para ti</p>
        </div>
        <app-search-bar (search)="onSearch($event)"></app-search-bar>
        <app-trending-grid
          [songs]="trendingSongs()"
          [loading]="trendingLoading()"
          (addToPlaylist)="onAddToPlaylist($event)"
          (playNow)="onPlayNow($event)">
        </app-trending-grid>
      </div>
    }

    <!-- SEARCH VIEW -->
    @if (currentView() === 'search') {
      <div class="view-pane view-search">
        <div class="view-header">
          <h1 class="view-title font-display">Buscar</h1>
          <p class="view-subtitle">Encuentra tu proxima cancion favorita</p>
        </div>
        <app-search-bar (search)="onSearch($event)"></app-search-bar>
        <app-search-results
          [results]="searchResults()"
          [loading]="searchLoading()"
          [visible]="true"
          (addToPlaylist)="onAddToPlaylist($event)"
          (playNow)="onPlayNow($event)">
        </app-search-results>
        <!-- Also show trending below if no results -->
        @if (!searchLoading() && searchResults().length === 0) {
          <app-trending-grid
            [songs]="trendingSongs()"
            [loading]="trendingLoading()"
            (addToPlaylist)="onAddToPlaylist($event)"
            (playNow)="onPlayNow($event)">
          </app-trending-grid>
        }
      </div>
    }

    <!-- NOW PLAYING VIEW -->
    @if (currentView() === 'nowplaying') {
      <div class="view-pane view-nowplaying">
        <div class="nowplaying-layout">
          <div class="nowplaying-left">
            <app-turntable [isPlaying]="isPlaying()"></app-turntable>
            @if (hasSong()) {
              <div class="nowplaying-info">
                <h2 class="nowplaying-title font-display">{{ currentSong()?.title }}</h2>
                <p class="nowplaying-artist">{{ currentSong()?.channel }}</p>
              </div>
            }
            @if (jamActive()) {
              <app-jam-panel></app-jam-panel>
            }
          </div>
          <div class="nowplaying-right">
            <app-playlist></app-playlist>
          </div>
        </div>
      </div>
    }

    <!-- LIBRARY VIEW -->
    @if (currentView() === 'library') {
      <div class="view-pane view-library">
        <div class="view-header">
          <h1 class="view-title font-display">Tu Biblioteca</h1>
          <p class="view-subtitle">Tu coleccion personal de musica</p>
        </div>
        <app-playlist></app-playlist>
      </div>
    }
  </main>
</div>

<!-- ═══ BOTTOM PLAYER BAR ═══ -->
@if (hasSong()) {
  <div class="bottom-bar">
    <app-player-controls></app-player-controls>
  </div>
}

<!-- FAB for Jam -->
@if (hasSong() && !jamActive()) {
  <button class="jam-fab" (click)="onStartJam()" title="Empezar Jam">
    <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
  </button>
}

<!-- Hidden YouTube Player -->
<div id="yt-player-container">
  <div id="yt-player"></div>
</div>

<!-- Toast -->
<div class="toast" [class.show]="toastVisible()">{{ toastMessage() }}</div>

<!-- Jam Join Dialog -->
<app-jam-join></app-jam-join>
